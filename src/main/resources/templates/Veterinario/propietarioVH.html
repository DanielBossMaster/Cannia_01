<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historia Clínica Veterinaria</title>
    <link rel="stylesheet" href="/css/VeterinarioCss/propietarioVH.css">
</head>
<body>

<header>
    <div class="logo">
        <img src="/img/HistoriaClinica.png" alt="logo">
    </div>
    <h1>Historia Clínica</h1>
    <div class="Barra">
        <input type="text" id="searchInput" placeholder="Ingrese el documento">
    </div>
    <h2>Veterinario</h2>
</header>

<main id="ownersContainer">
    <!-- Aquí se pintan propietarios desde Thymeleaf -->
    <div th:each="propietario : ${propietarios}" class="card">
        <h3 th:text="${propietario.nombrePro}"></h3>
        <p><b>Documento:</b> <span th:text="${propietario.numDoc}"></span></p>
        <p><b>Teléfono:</b> <span th:text="${propietario.telefonoPro}"></span></p>
        <p><b>Correo:</b> <span th:text="${propietario.correoPro}"></span></p>
        <button class="btn btn-primary"
                th:attr="onclick=|toggleMascotas(${propietario.id})|">Consultar Animales</button>

        <!-- Lista de mascotas -->
        <div class="animal-list" th:id="'mascotas-' + ${propietario.id}" style="display:none;">

            <div th:each="mascota : ${propietario.mascotas}" class="animal-item"
                 th:attr="onclick=|selectMascota(${propietario.id}, ${mascota.id})|">

                <p>
                    <b th:text="${mascota.nomMascota}"></b>
                    (<span th:text="${mascota.especie}"></span>)
                </p>

                <!-- Opciones ocultas (solo aparecen al seleccionar mascota) -->
                <div class="options" th:id="'options-' + ${mascota.id}" style="display:none; margin-top:10px;">
                    <button class="btn btn-success"
                            th:attr="onclick=|openModal('vacunaModal', '${propietario.id}', '${mascota.id}')|">
                        Agregar vacuna
                    </button>
                    <button class="btn btn-info"
                            th:attr="onclick=|openModal('historyModal', '${propietario.id}', '${mascota.id}')|">
                        Generar historia clínica
                    </button>
                </div>
            </div>

            <p th:if="${#lists.isEmpty(propietario.mascotas)}">
                Este propietario no tiene mascotas registradas
            </p>
        </div>
</main>

<!-- Contenedor donde aparecen los botones -->
<div id="accionesMascota" style="display:none; margin-top:10px;">
    <button onclick="abrirModalVacuna()">Agregar vacuna</button>
    <button onclick="abrirModalHistoria()">Generar historia clínica</button>
</div>


<!-- Modal Vacuna -->
<div id="vacunaModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('historyModal')">X</button>
        <h2>Agregar Vacuna - Mascota</h2>

        <form method="post" th:action="@{/vacuna/guardar}">
            <input type="hidden" id="vacunaPropietarioId" name="idPropietario">
            <input type="hidden" id="vacunaMascotaId" name="idMascota">

            <label>Lote:</label>
            <input type="text" name="lote" required>

            <label>Fecha Aplicación:</label>
            <input type="date" name="fechaAplicacion" required>

            <label>Fecha Refuerzo:</label>
            <input type="date" name="fechaRefuerzo">

            <label>Fecha Vencimiento:</label>
            <input type="date" name="fechaVencimiento">

            <label>Laboratorio:</label>
            <input type="text" name="laboratorio">

            <label>Tratamiento:</label>
            <textarea name="tratamiento"></textarea>

            <label>Nombre Veterinario:</label>
            <input type="text" name="nombreVete" required>

            <button type="submit" class="btn-generate">Guardar Vacuna</button>
        </form>
    </div>
</div>


<!-- Modal Historia Clínica -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('historyModal')">X</button>
        <h2>Historia Clínica - Mascota</h2>

        <form method="post" th:action="@{/historia/guardar}">
            <input type="hidden" id="historiaPropietarioId" name="idPropietario">
            <input type="hidden" id="historiaMascotaId" name="idMascota">

            <label>Peso:</label>
            <input type="number" step="0.01" name="peso" required>

            <label>Anamnesis:</label>
            <textarea name="anamnesis" required></textarea>

            <label>Diagnóstico:</label>
            <textarea name="diagnostico" required></textarea>

            <label>Tratamiento:</label>
            <textarea name="tratamiento" required></textarea>

            <label>Fecha y Hora:</label>
            <input type="datetime-local" name="fechaHora" required>

            <button type="submit" class="btn-generate">Generar Historia Clínica</button>
        </form>
    </div>
</div>


<!-- Librería para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const modal = document.getElementById("historyModal");
    const modalTitle = document.getElementById("modalTitle");
    let selectedOwner = null;
    let selectedAnimal = null;

    // Mostrar/ocultar mascotas
    function toggleMascotas(id) {
        const div = document.getElementById("mascotas-" + id);
        div.style.display = (div.style.display === "none") ? "block" : "none";
    }

    // Abrir modal
    function openModal(modalId, propietarioId, mascotaId) {
        document.getElementById(modalId).style.display = "block";

        if(modalId === "vacunaModal"){
            document.getElementById("vacunaPropietarioId").value = propietarioId;
            document.getElementById("vacunaMascotaId").value = mascotaId;
        }
        if(modalId === "historyModal"){
            document.getElementById("historiaPropietarioId").value = propietarioId;
            document.getElementById("historiaMascotaId").value = mascotaId;
        }
    }


    // Cerrar modal
    function closeModal() {
        modal.style.display = "none";
    }

    // Generar Excel
    document.getElementById("historyForm").addEventListener("submit", function(event) {
        event.preventDefault();

        const peso = document.getElementById("peso").value;
        const diagnostico = document.getElementById("diagnostico").value;
        const anamnesis = document.getElementById("anamnesis").value;
        const tratamiento = document.getElementById("tratamiento").value;
        const fechaHora = document.getElementById("fechaHora").value;

        if (!peso ||!anamnesis || !diagnostico || !tratamiento || !fechaHora) {
            alert("Por favor completa todos los campos.");
            return;
        }

        const data = [
            ["Historia Clínica Veterinaria"],
            [],
            ["Propietario", selectedOwner.nombre],
            ["Documento", selectedOwner.documento],
            ["Teléfono", selectedOwner.telefono],
            ["Correo", selectedOwner.email],
            ["Mascota", selectedAnimal.nomMascota],
            ["Especie", selectedAnimal.especie],
            ["Raza", selectedAnimal.raza],
            ["Color", selectedAnimal.color],
            [],
            ["Peso", peso],
            ["Fecha y Hora", fechaHora],
            ["Anamnesis", anamnesis],
            ["Diagnóstico", diagnostico],
            ["Tratamiento", tratamiento]
        ];

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Historia Clínica");

        XLSX.writeFile(wb, `Historia_${selectedAnimal}.xlsx`);
        closeModal();
    });


    function selectMascota(ownerId, mascotaId) {
        // Oculta todas las opciones
        document.querySelectorAll(".options").forEach(opt => opt.style.display = "none");

        // Muestra solo las opciones de la mascota seleccionada
        const options = document.getElementById("options-" + mascotaId);
        if (options) {
            options.style.display = "flex";
            options.style.flexDirection = "column"; // botones en columna
            options.style.gap = "8px"; // espacio entre botones
        }
    }


</script>

</body>
</html>
