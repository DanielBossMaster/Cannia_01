<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historia Clínica Veterinaria</title>
    <link rel="stylesheet" href="/css/VeterinarioCss/propietarioVH.css">
</head>
<body>

<header>
    <div class="logo">
        <img src="/img/HistoriaClinica.png" alt="logo">
    </div>
    <h1>Historia Clínica</h1>
    <div class="Barra">
        <input type="text" id="searchInput" placeholder="Ingrese el documento">
    </div>
    <h2>Veterinario</h2>
</header>

<main id="ownersContainer">
    <!-- Aquí se pintan propietarios desde Thymeleaf -->
    <div th:each="propietario : ${propietarios}" class="card">
        <h3 th:text="${propietario.nombrePro}"></h3>
        <p><b>Documento:</b> <span th:text="${propietario.numDoc}"></span></p>
        <p><b>Teléfono:</b> <span th:text="${propietario.telefonoPro}"></span></p>
        <p><b>Correo:</b> <span th:text="${propietario.correoPro}"></span></p>
        <button class="btn btn-primary"
                th:attr="onclick=|toggleMascotas(${propietario.id})|">Consultar Animales</button>

        <!-- Lista de mascotas -->
        <div class="animal-list" th:id="'mascotas-' + ${propietario.id}" style="display:none;">
            <div th:each="mascota : ${propietario.mascotas}" class="animal-item">
                <p><b th:text="${mascota.nomMascota}"></b>
                    (<span th:text="${mascota.especie}"></span>)</p>
                <button class="btn btn-info"
                        th:attr="onclick=|openModal(${propietario.id}, ${mascota.id})|">
                    Generar historia clínica
                </button>
            </div>
            <p th:if="${#lists.isEmpty(propietario.mascotas)}">Este propietario no tiene mascotas registradas</p>
        </div>
    </div>
</main>

<!-- Modal para historia clínica -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">X</button>
        <h2 id="modalTitle">Generar Historia Clínica</h2>

        <!-- Formulario -->
        <form id="historyForm">
            <div>
                <label><b>Peso</b></label><br>
                <textarea id="peso" name="peso" rows="1" required></textarea>
            </div>
            <div>
                <label><b>Diagnóstico</b></label><br>
                <textarea id="diagnostico" name="diagnostico" rows="2" required></textarea>
            </div>
            <div>
                <label><b>Tratamiento</b></label><br>
                <textarea id="tratamiento" name="tratamiento" rows="2" required></textarea>
            </div>
            <div>
                <label><b>Fecha y Hora</b></label><br>
                <input type="datetime-local" id="fechaHora" name="fechaHora" required>
            </div>
            <button type="submit" class="btn-generate">Generar Historia Clínica</button>
        </form>
    </div>
</div>

<!-- Librería para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const modal = document.getElementById("historyModal");
    const modalTitle = document.getElementById("modalTitle");
    let selectedOwner = null;
    let selectedAnimal = null;

    // Mostrar/ocultar mascotas
    function toggleMascotas(id) {
        const div = document.getElementById("mascotas-" + id);
        div.style.display = (div.style.display === "none") ? "block" : "none";
    }

    // Abrir modal
    function openModal(ownerId, animalId) {
        selectedOwner = ownerId;
        selectedAnimal = animalId;
        modal.style.display = "flex";
        modalTitle.textContent = `Historia Clínica - Mascota ID ${animalId}`;
    }

    // Cerrar modal
    function closeModal() {
        modal.style.display = "none";
    }

    // Generar Excel
    document.getElementById("historyForm").addEventListener("submit", function(event) {
        event.preventDefault();

        const peso = document.getElementById("peso").value;
        const diagnostico = document.getElementById("diagnostico").value;
        const tratamiento = document.getElementById("tratamiento").value;
        const fechaHora = document.getElementById("fechaHora").value;

        if (!peso || !diagnostico || !tratamiento || !fechaHora) {
            alert("Por favor completa todos los campos.");
            return;
        }

        const data = [
            ["Historia Clínica Veterinaria"],
            [],
            ["Propietario ID", selectedOwner],
            ["Mascota ID", selectedAnimal],
            ["Peso", peso],
            ["Fecha y Hora", fechaHora],
            ["Diagnóstico", diagnostico],
            ["Tratamiento", tratamiento]
        ];

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Historia Clínica");

        XLSX.writeFile(wb, `Historia_${selectedAnimal}.xlsx`);
        closeModal();
    });
</script>

</body>
</html>
